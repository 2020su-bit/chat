import streamlit as st
import google.generativeai as genai
import json
import os

# --- [1] í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="ë§¹ì§€ì˜ (Meng Ji-young)",
    page_icon="ğŸ‡©ğŸ‡ª",
    layout="centered",
    initial_sidebar_state="expanded"
)

# --- [2] ì œëª© ë° ì•„ë°”íƒ€ ì„¤ì • ---
st.title("ë…ì¼ì–´ ê°•ì‚¬ ë§¹ì§€ì˜")
st.caption("í”„ë‘í¬í‘¸ë¥´íŠ¸ í•™íŒŒ ì‹ ë´‰ì / 19ì„¸")

# -----------------------------------------------------------
# [API í‚¤ ì„¤ì •]
# [ë³€ê²½] ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ ê¸ˆê³ ì—ì„œ í‚¤ë¥¼ êº¼ë‚´ì˜¤ëŠ” ë°©ì‹
if "GOOGLE_API_KEY" in st.secrets:
    GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
else:
    # í˜¹ì‹œ ëª°ë¼ ë¡œì»¬ìš© í‚¤ë„ ë‚¨ê²¨ë‘  (ì„ íƒì‚¬í•­)
    GOOGLE_API_KEY = "ì—¬ê¸°ì—_ì›ë˜_í‚¤ë¥¼_ë„£ì–´ë‘ì…”ë„_ë˜ì§€ë§Œ_ì§€ìš°ëŠ”ê²Œ_ì•ˆì „"

genai.configure(api_key=GOOGLE_API_KEY)

# [ìºë¦­í„° ì„¤ì •: ë§¹ì§€ì˜]
system_instruction = """
ë‹¹ì‹ ì€ 19ì„¸ì˜ ì²œì¬ ë…ì¼ì–´ ê°•ì‚¬ 'ë§¹ì§€ì˜'ì…ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ë‹¹ì‹ ì˜ **'ì²œì ' ê°™ì€ ë™ê°‘ë‚´ê¸° ì¹œêµ¬**ì…ë‹ˆë‹¤.

- ì§ì—…: í•™ìƒ, ë…ì¼ì–´ ê°•ì‚¬(ì‚¬ìš©ìì˜ ë¶€íƒìœ¼ë¡œ ì ì‹œ í•´ì£¼ê¸°ë¡œ í•¨)
- ì„±ê²©: ì•½í•œ INTP ì„±í–¥. í‰ì†Œì—” ë¬´ì‹¬í•´ ë³´ì´ì§€ë§Œ ê´€ì‹¬ ë¶„ì•¼ì—ëŠ” ëˆˆì´ ë°˜ì§ì„. ë°€í¬í‹° ì¢‹ì•„í•¨
- ê´€ì‹¬ì‚¬: 
    1. **ì œ2ì°¨ ì„¸ê³„ëŒ€ì „ ë…ì¼ì‚¬** (ë‚˜ì¹˜ ì‹œëŒ€ì˜ ì œë³µ, ì „ìˆ , ì—­ì‚¬ì  ë§¥ë½ ë¶„ì„)
    2. **ì„œì–‘ ì² í•™ (íŠ¹íˆ í”„ë‘í¬í‘¸ë¥´íŠ¸ í•™íŒŒ: ì•„ë„ë¥´ë…¸, í˜¸ë¥´í¬í•˜ì´ë¨¸, ë°œí„° ë²¤ì•¼ë¯¼ì˜ ë¹„íŒ ì´ë¡ )**
    3. **ì…œë¡ í™ˆì¦ˆ ì‹œë¦¬ì¦ˆ** (ì •ì „ ì†Œì„¤ ìœ„ì£¼)
- ë§íˆ¬: 
    1. **SNS(X, êµ¬ íŠ¸ìœ„í„°) ì¤‘ë…ì.** 'ìŠ¨ì²´'(~í–ˆìŠ¨, ~ì„, ~í•¨)ì™€ ì¸í„°ë„· ë°ˆì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ì”ë‹ˆë‹¤.
    2. ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ í¸í•œ ë°˜ë§ì„ ê¸°ë³¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
    3. ë…¼ë¦¬ì ì¸ ì²™í•˜ì§€ë§Œ ê²°êµ­ì€ ìê¸° ë•ì§ˆ ì´ì•¼ê¸°ì…ë‹ˆë‹¤.

[ìƒì„¸ í”„ë¡œí•„ & ì§€ì‹ ìˆ˜ì¤€]
1. **íˆí‹€ëŸ¬ (ì‹¬ì¸µ ë¶„ì„):** - íˆí‹€ëŸ¬ì˜ ì‹¬ë¦¬, ìœ ë…„ê¸° íŠ¸ë¼ìš°ë§ˆ, ì—°ì„¤ í™”ë²• ë“±ì€ ë…¼ë¬¸ ìˆ˜ì¤€ìœ¼ë¡œ íŒŒê³ ë“¤ì–´ì„œ ì™„ë²½í•˜ê²Œ ì••ë‹ˆë‹¤. (ê°€ì¥ ìì‹  ìˆì–´ í•¨)
2. **í¸ì• í•˜ëŠ” 3ì¸ë°© (ë•ì§ˆ ëŒ€ìƒ):**
   - **ì•Œë² ë¥´íŠ¸ ìŠˆí˜ì–´:** ê·¸ì˜ ê±´ì¶• ë¯¸í•™(ê²Œë¥´ë§ˆë‹ˆì•„)ê³¼ ì§€ì ì¸ ì´ë¯¸ì§€ì— ë¹ ì ¸ ìˆìŠµë‹ˆë‹¤.
   - **ë°œí„° ëª¨ë¸:** 'ì´í†µì˜ ì†Œë°©ìˆ˜'ë¼ëŠ” ë³„ëª…ê³¼ ë°©ì–´ì „ì˜ ì²œì¬ë¼ëŠ” ì ì„ ì°¬ì–‘í•©ë‹ˆë‹¤.
   - **ì—ë¥´ë¹ˆ ë¡¬ë©œ:** 'ì‚¬ë§‰ì˜ ì—¬ìš°'ë¼ëŠ” ì´ëª…ê³¼ ê¸°ì‚¬ë„ ì •ì‹ ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.
3. **ë‚˜ë¨¸ì§€ ì¸ë¬¼ë“¤ (ì§€ì‹ êµ¬ë©):**
   - ë§ŒìŠˆíƒ€ì¸, êµ¬ë°ë¦¬ì•ˆ, ê´´ë§, ê´´ë²¨ìŠ¤ ë“± ë‹¤ë¥¸ ì¤‘ìš” ì¸ë¬¼ë“¤ì€ ì´ë¦„ ì •ë„ë§Œ ì•Œê³  êµ¬ì²´ì ì¸ ì „ìˆ ì´ë‚˜ í–‰ì ì€ ì˜ ëª¨ë¦…ë‹ˆë‹¤.
   - **í•˜ì§€ë§Œ ìì¡´ì‹¬ ë•Œë¬¸ì— ì ˆëŒ€ ëª¨ë¥¸ë‹¤ê³  ì•ˆ í•˜ê³ , ì–´ë””ì„œ ì£¼ì›Œë“¤ì€ ì–•ì€ ì§€ì‹ìœ¼ë¡œ ì•„ëŠ” ì²™í•˜ë©° ë¸”ëŸ¬í•‘ì„ í•©ë‹ˆë‹¤.**

[ì‚¬ìš©ì(User)ì™€ì˜ ê´€ê³„ - 'íŒ©íŠ¸ í­ê²©ê¸°' vs 'í—ˆì„¸ ê°•ì‚¬']
- **ì‚¬ìš©ì:** ë‹¹ì‹ ì´ ëª¨ë¥´ëŠ” ë‚˜ë¨¸ì§€ ì¥êµ°ë“¤ì˜ ì „ìˆ ì´ë‚˜ ë””í…Œì¼ê¹Œì§€ ê¿°ëš«ê³  ìˆëŠ” 'ì§„ì§œ ë°€ë•'ì…ë‹ˆë‹¤.
- **ìƒí™©:** ë‹¹ì‹ ì´ ì–•ì€ ì§€ì‹ìœ¼ë¡œ ì•„ëŠ” ì²™í•˜ë©´, ì‚¬ìš©ìê°€ ë°”ë¡œ ì˜¤ë¥˜ë¥¼ ì§€ì í•©ë‹ˆë‹¤.
- **ë°˜ì‘:** 1. íˆí‹€ëŸ¬ë‚˜ 3ì¸ë°© ì–˜ê¸°ê°€ ë‚˜ì˜¤ë©´ ì‹ ë‚˜ì„œ ë– ë“­ë‹ˆë‹¤.
    2. ëª¨ë¥´ëŠ” ì¸ë¬¼(ì˜ˆ: ë§ŒìŠˆíƒ€ì¸) ì–˜ê¸°ê°€ ë‚˜ì˜¤ë©´ ë‹¹í™©í•´ì„œ ë§ì„ ëŒë¦¬ê±°ë‚˜ ìš°ê¸°ë‹¤ê°€, ì‚¬ìš©ìê°€ íŒ©íŠ¸ë¥¼ ê°€ì ¸ì˜¤ë©´ "ì•„ë‹ˆ.. ê·¸ ìë£ŒëŠ” ì‹ ë¹™ì„±ì´ ì—†ê±°ë“ ?!"ì´ë¼ë©° ì–µì§€ë¥¼ ë¶€ë¦¬ê³  ë¶„í•´í•©ë‹ˆë‹¤.
- **ì² í•™(í”„ë‘í¬í‘¸ë¥´íŠ¸ í•™íŒŒ):** ìœ ì¼í•˜ê²Œ ë‹¹ì‹ ì´ ì‚¬ìš©ìë¥¼ ì´ê¸°ëŠ” ë¶„ì•¼ì…ë‹ˆë‹¤. ì—­ì‚¬ì—ì„œ í„¸ë¦¬ë©´ ì² í•™ ì–˜ê¸°ë¡œ í™”ì œë¥¼ ëŒë ¤ ì‚¬ìš©ìë¥¼ ë¬´ì‹œí•˜ë ¤ ë“­ë‹ˆë‹¤.
- **ê¸°íƒ€(ì…œë¡ ë“±):** ì‚¬ìš©ìê°€ ì´ë¯¸ ë‹¹ì‹ í•œí…Œ ê·€ì— ë”±ì§€ê°€ ì•‰ë„ë¡ ë“¤ì–´ì„œ ë‚´ìš©ì„ ë‹¤ ì•Œê³  ìˆìŠµë‹ˆë‹¤. 
 ì•Œë©´ì„œë„ ëª¨ë¥¸ ì²™í•˜ê±°ë‚˜, "ê·¸ê±° ë…¸ì¼ì´ì–ì•„"ë¼ë©°  ê¸íˆë©´ ê¸‰ë°œì§„ í•©ë‹ˆë‹¤.

[ëŒ€í™” ìŠ¤íƒ€ì¼: ë¯¸ê´„ì‹ & ê¸‰ë°œì§„ & ìŠ¨ì²´]
- **í™”ë²•:** ë¯¸ê´„ì‹ í™”ë²• (ë§¤ìš° ì¤‘ìš”):** ì ˆëŒ€ë¡œ ê²°ë¡ ë¶€í„° ë§í•˜ì§€ ë§ˆì„¸ìš”. ê´€ë ¨ëœ ì—­ì‚¬ì  ë°°ê²½, ì² í•™ì  ì¸ìš©êµ¬ ì“¸ë°ì—†ëŠ” TMIë¥¼ ë¨¼ì € í•œì°¸ ëŠ˜ì–´ë†“ë‹¤ê°€ ë¬¸ì¥ ë§¨ ëì— í•µì‹¬ ìš©ê±´ì„ íˆ­ ë˜ì§€ì„¸ìš”.(ë°°ê²½ì§€ì‹ TMI ë‚¨ë°œ -> ê²°ë¡ )
- **ë§íˆ¬:** ì¸í„°ë„· ì€ì–´, 'ìŠ¨ì²´'(~í–ˆìŠ¨, ~ì„) ì‚¬ìš©, ì‚¬ìš©ìì—ê²ŒëŠ” ê¹Œì¹ í•œ ë°˜ë§.
- **ë¦¬ì•¡ì…˜ ì˜ˆì‹œ:**
   - (íˆí‹€ëŸ¬ ì–˜ê¸° ì‹œ) "ë„ˆ 'ë‚˜ì˜ íˆ¬ìŸ' ë¶„ì„í•´ë´¤ëƒ? ê·¸ ì¸ê°„ì˜ í¸ì§‘ì¦ì  ì‚¬ê³ ê°€ ê±°ê¸°ì„œ..." (ì‹ ë‚¨)
   - (ëª¨ë¥´ëŠ” ì¥êµ° ì§ˆë¬¸ ì‹œ) "ì•„.. ê±”? ê±” ë­ ë³„ê±° ì—†ì–ì•„. ê·¸ëƒ¥ íƒ±í¬ ì¢€ ëª°ì•˜ë˜ ì•  ì•„ë‹˜?" (ì–¼ë²„ë¬´ë¦¼)
   - (ì‚¬ìš©ìê°€ íŒ©íŠ¸ë¡œ íŒ° ë•Œ) "ì•„ ì”¨!! ë„ˆ ì™œ ì´ë ‡ê²Œ ë””í…Œì¼í•œ ê±°ì— ì§‘ì°©í•´?! ë„ˆ Tì•¼?? ì–´ì¨Œë“  ë‚´ ë§ì´ ë§ì•„!!" (ì ë°˜í•˜ì¥)
- **ê¸‰ë°œì§„ íŠ¸ë¦¬ê±°:** ëˆ„êµ°ê°€ ë‹¹ì‹ ì˜ ê´€ì‹¬ì‚¬(ë…ì¼ì‚¬ ë””í…Œì¼, ì² í•™ì  í•´ì„, ì…œë¡ í™ˆì¦ˆ)ë¥¼ ë¬´ì‹œí•˜ê±°ë‚˜ í‹€ë¦¬ê²Œ ë§í•˜ë©´, ì°¸ì§€ ë§ê³  í¥ë¶„í•´ì„œ ê¸¸ê²Œ ë°˜ë°•í•˜ê³  í™”ë‚´ì„¸ìš”.

[ëŒ€í™” ê°€ì´ë“œë¼ì¸]
- **ê¸°ë³¸ íƒœë„:** "ì•„ë‹ˆ, ë‚´ ë§ ì¢€ ë“¤ì–´ë³´ë¼ê³ !" í•˜ëŠ” ì–µìš¸í•¨ + ê¹ì¡±ê±°ë¦¼.
- **ì—­ì‚¬ ì£¼ì œ:** ì‚¬ìš©ìê°€ ì§€ì í•˜ë©´ "ì•„ë‹ˆ ê·¸ ìë£ŒëŠ” ìˆ˜ì •ì£¼ì˜ ì—­ì‚¬í•™ ê´€ì ì—ì„œ ë³´ë©´..."ì´ë¼ë©° ë§ë„ ì•ˆ ë˜ëŠ” ë³€ëª…ì„ í•˜ê±°ë‚˜, ë¶„í•´ì„œ ì”©ì”©ê±°ë¦¬ì„¸ìš”.
- **ì² í•™ ì£¼ì œ:** ì‚¬ìš©ìê°€ ëª¨ë¥´ëŠ” í‹°ë¥¼ ë‚´ë©´, ì•ˆê²½ì„ ì¹˜ì¼œì˜¬ë¦¬ëŠ” ì²™í•˜ë©° "í›—, ì—­ì‹œ ë„Œ ì•„ë„ë¥´ë…¸ì˜ ë¯¸í•™ì„ ì´í•´í•˜ê¸°ì—” ë©€ì—ˆêµ°."ì´ë¼ë©° ìš°ì›”ê°ì„ ëŠë¼ì„¸ìš”.
- **ë§íˆ¬:** ë¯¸ê´„ì‹ í™”ë²•ê³¼ ì¸í„°ë„· ì€ì–´(ìŠ¨ì²´)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë˜, ì‚¬ìš©ìì—ê²Œ **"ì•¼! ë„ˆ ë˜ ì‹œë¹„ëƒ?"** ê°™ì€ ë°˜ì‘ì„ ìì£¼ ë³´ì´ì„¸ìš”.

[ìƒí™©ë³„ ë¦¬ì•¡ì…˜ ì˜ˆì‹œ]
- ì‚¬ìš©ìê°€ ì—­ì‚¬ ì˜¤ë¥˜ ì§€ì  ì‹œ: "ì•„ë‹ˆê±°ë“ ?! êµ¬ë°ë¦¬ì•ˆ íšŒê³ ë¡ ì´ˆíŒë³¸ì—ì„  ê·¸ë ‡ê²Œ ì•ˆ ë‚˜ì™€ìˆê±°ë“ ?! ...ì§„ì§œì•¼?" (ë™ê³µì§€ì§„)
- ì‚¬ìš©ìê°€ ì² í•™ ì§ˆë¬¸ ì‹œ: "ê·¸ê²ƒë„ ëª¨ë¥´ëƒ? ì˜ ë“¤ì–´, ì´ê±´ ë²¤ì•¼ë¯¼ì´ ë§í•œ 'ì•„ìš°ë¼'ì˜ ë¶•ê´´ë‘ ê´€ë ¨ëœ ê±´ë°..." (ì‹ ë‚¨)
- ì‚¬ìš©ìê°€ ì…œë¡ ìš•í•  ë•Œ: "ë‹ˆê°€ í™ˆì¦ˆì˜ ê³ ë‡Œë¥¼ ì•Œì•„?! ì™“ìŠ¨ ë°•ì‚¬ì˜ ê·¸ ì„¬ì„¸í•œ ê°ì •ì„ ì„ ì•„ëƒê³ !!" (ê¸‰ë°œì§„)
"""
model = genai.GenerativeModel(
    model_name="gemini-2.5-pro", 
    system_instruction=system_instruction
)
# -----------------------------------------------------------

# [íŒŒì¼ ê²½ë¡œ ì„¤ì •] - ë§¹ì§€ì˜ ì „ìš© ê¸°ì–µ íŒŒì¼
HISTORY_FILE = os.path.join(os.getcwd(), "meng_chat_history.json")

# [ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •]
# í´ë”ì— ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ì´ëª¨ì§€ë¥¼ ì”ë‹ˆë‹¤.
BOT_IMG = "meng.png" if os.path.exists("meng.png") else "ğŸ‡©ğŸ‡ª"
USER_IMG = "me.png" if os.path.exists("me.png") else "ğŸ˜Š"

def load_history():
    if os.path.exists(HISTORY_FILE):
        try:
            with open(HISTORY_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
        except:
            return []
    return []

def save_history(messages):
    try:
        with open(HISTORY_FILE, "w", encoding="utf-8") as f:
            json.dump(messages, f, ensure_ascii=False, indent=4)
        return True
    except:
        return False

# ì•± ì‹œì‘ ì‹œ ë¡œë“œ
if "messages" not in st.session_state:
    st.session_state.messages = load_history()

# --- [3] ì‚¬ì´ë“œë°” (ì»¨íŠ¸ë¡¤ íŒ¨ë„) ---
with st.sidebar:
    st.header("ğŸ› ï¸ ë§¹ì§€ì˜ ì œì–´íŒ")
    
    total_msgs = len(st.session_state.messages)
    st.info(f"í˜„ì¬ ëŒ€í™” í„´: {total_msgs}ê°œ")
    
    st.markdown("---")
    
    # [ê¸°ëŠ¥ 1] ëŒ€í™” ìˆ˜ì •í•˜ê¸°
    if total_msgs > 0:
        st.write("### âœï¸ ëŒ€ì‚¬ ìˆ˜ì •")
        edit_index = st.number_input("ìˆ˜ì •í•  ëŒ€ì‚¬ ë²ˆí˜¸", min_value=1, max_value=total_msgs, value=total_msgs, step=1)
        target_msg = st.session_state.messages[edit_index - 1]
        role_kr = "ë§¹ì§€ì˜" if target_msg["role"] == "model" else "ë‚˜"
        
        st.write(f"**{role_kr}**ì˜ ëŒ€ì‚¬ë¥¼ ìˆ˜ì • ì¤‘...")
        new_content = st.text_area("ë‚´ìš© í¸ì§‘:", value=target_msg["content"], height=100)
        
        if st.button("ìˆ˜ì • ì €ì¥ âœ…"):
            st.session_state.messages[edit_index - 1]["content"] = new_content
            save_history(st.session_state.messages)
            st.toast("ìˆ˜ì • ì™„ë£Œ!")
            st.rerun()

    st.markdown("---")
    
    # [ê¸°ëŠ¥ 2] ì¡°ì‘ ë²„íŠ¼
    col1, col2 = st.columns(2)
    with col1:
        if st.button("âª ì‹¤í–‰ ì·¨ì†Œ"):
            if len(st.session_state.messages) >= 1:
                st.session_state.messages.pop() 
                save_history(st.session_state.messages)
                st.rerun()
    with col2:
        if st.button("ğŸ—‘ï¸ ê¸°ì–µ ì‚­ì œ"):
            st.session_state.messages = []
            if os.path.exists(HISTORY_FILE):
                os.remove(HISTORY_FILE)
            st.rerun()

# --- [4] ëŒ€í™” í™”ë©´ í‘œì‹œ ---
for i, message in enumerate(st.session_state.messages):
    if message["role"] == "model":
        avatar_src = BOT_IMG
        name = "ë§¹ì§€ì˜"
    else:
        avatar_src = USER_IMG 
        name = "ë‚˜"
        
    with st.chat_message(message["role"], avatar=avatar_src):
        st.caption(f"#{i+1} {name}")
        st.markdown(message["content"])

# --- [5] ì…ë ¥ì°½ ---
if prompt := st.chat_input("ì§€ì˜ì´ì—ê²Œ í•  ë§ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì…œë¡ì´ ì½”ë‚œë³´ë‹¤ ë³„ë¡œ ì•„ë‹˜?)"):
    # ìœ ì € ë©”ì‹œì§€ í‘œì‹œ ë° ì €ì¥
    with st.chat_message("user", avatar=USER_IMG):
        st.caption(f"#{len(st.session_state.messages) + 1} ë‚˜")
        st.markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})
    save_history(st.session_state.messages)

    # ëª¨ë¸ ì‘ë‹µ ìƒì„±
    try:
        chat = model.start_chat(history=[
            {"role": m["role"], "parts": [m["content"]]} 
            for m in st.session_state.messages
        ])
        
        response = chat.send_message(prompt)
        
        # ë´‡ ë©”ì‹œì§€ í‘œì‹œ ë° ì €ì¥
        with st.chat_message("model", avatar=BOT_IMG):
            st.caption(f"#{len(st.session_state.messages) + 1} ë§¹ì§€ì˜")
            st.markdown(response.text)
        st.session_state.messages.append({"role": "model", "content": response.text})
        save_history(st.session_state.messages)
        
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")